<!DOCTYPE html>
<html>
<head>
    <title>æµ‹è¯•äº‘é›¾ API</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            max-width: 900px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        h1 { color: #4fc3f7; }
        h2 { color: #81c784; margin-top: 0; }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #fff;
            font-family: inherit;
            box-sizing: border-box;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 3px solid #4caf50;
            font-size: 12px;
            line-height: 1.5;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
        .label {
            display: inline-block;
            min-width: 120px;
            color: #aaa;
        }
        .value {
            color: #fff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.success { background: #4caf50; }
        .status-badge.error { background: #f44336; }
        .status-badge.pending { background: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ§ª äº‘é›¾ API æµ‹è¯•å·¥å…·</h1>
    <p>ç›´æ¥æµ‹è¯•äº‘é›¾ API è¿æ¥å’ŒåŠŸèƒ½</p>

    <div class="section">
        <h2>1. API é…ç½®</h2>
        <label>
            <span class="label">API Key:</span>
            <input type="text" id="apiKey" placeholder="sk-..." />
        </label>
        <button onclick="saveApiKey()">ä¿å­˜ API Key</button>
        <button onclick="clearApiKey()">æ¸…é™¤</button>
        <p id="apiKeyStatus" class="info"></p>
    </div>

    <div class="section">
        <h2>2. æµ‹è¯•æäº¤ä»»åŠ¡</h2>
        <label>
            <span class="label">æç¤ºè¯ (Prompt):</span>
            <textarea id="prompt" rows="3">ä¸€åªå¯çˆ±çš„å°çŒ«å’ªåœ¨èŠ±å›­é‡Œç©è€ï¼Œé˜³å…‰æ˜åªšï¼ŒèŠ±å¼€æ»¡å›­</textarea>
        </label>
        <br>
        <label>
            <span class="label">æ–¹å‘:</span>
            <select id="orientation">
                <option value="landscape">æ¨ªå‘ (16:9)</option>
                <option value="portrait">çºµå‘ (9:16)</option>
            </select>
        </label>
        <br>
        <label>
            <span class="label">æ—¶é•¿:</span>
            <select id="duration">
                <option value="10">10ç§’</option>
                <option value="15" selected>15ç§’</option>
                <option value="25">25ç§’</option>
            </select>
        </label>
        <br>
        <label>
            <span class="label">å°ºå¯¸:</span>
            <select id="size">
                <option value="medium">æ ‡å‡† (medium)</option>
                <option value="large">é«˜æ¸… (large)</option>
            </select>
        </label>
        <br>
        <button onclick="testSubmitTask()" id="submitBtn">æµ‹è¯•æäº¤ä»»åŠ¡</button>
        <pre id="submitResult"></pre>
    </div>

    <div class="section">
        <h2>3. æµ‹è¯•æŸ¥è¯¢ä»»åŠ¡</h2>
        <label>
            <span class="label">ä»»åŠ¡ ID:</span>
            <input type="text" id="taskId" placeholder="sora-2:task_..." />
        </label>
        <button onclick="testQueryTask()" id="queryBtn">æµ‹è¯•æŸ¥è¯¢ä»»åŠ¡</button>
        <pre id="queryResult"></pre>
    </div>

    <div class="section">
        <h2>4. æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <pre id="logs"></pre>
    </div>

    <script>
        const API_KEY_KEY = 'yunwu_test_api_key';
        const YUNWU_API_BASE = 'https://yunwu.ai/v1';

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ API Key
        window.onload = function() {
            const savedKey = localStorage.getItem(API_KEY_KEY);
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateApiKeyStatus(true);
            }
        };

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }
            localStorage.setItem(API_KEY_KEY, key);
            updateApiKeyStatus(true);
            addLog('âœ… API Key å·²ä¿å­˜', 'success');
        }

        function clearApiKey() {
            localStorage.removeItem(API_KEY_KEY);
            document.getElementById('apiKey').value = '';
            updateApiKeyStatus(false);
            addLog('ğŸ—‘ï¸ API Key å·²æ¸…é™¤', 'info');
        }

        function updateApiKeyStatus(hasKey) {
            const status = document.getElementById('apiKeyStatus');
            if (hasKey) {
                const key = localStorage.getItem(API_KEY_KEY);
                status.innerHTML = `âœ… å·²é…ç½® (å‰10ä½: ${key.substring(0, 10)}...)`;
                status.className = 'success';
            } else {
                status.innerHTML = 'âŒ æœªé…ç½®';
                status.className = 'error';
            }
        }

        function getApiKey() {
            return localStorage.getItem(API_KEY_KEY);
        }

        async function testSubmitTask() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('è¯·å…ˆä¿å­˜ API Key');
                return;
            }

            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('submitResult');

            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            resultDiv.innerHTML = '<div class="info">â³ æ­£åœ¨æäº¤ä»»åŠ¡...</div>';

            try {
                const requestBody = {
                    prompt: prompt,
                    model: 'sora-2',
                    orientation: document.getElementById('orientation').value,
                    duration: parseInt(document.getElementById('duration').value),
                    size: document.getElementById('size').value,
                    watermark: false,
                    images: []
                };

                addLog(`ğŸ“¤ å‘é€è¯·æ±‚åˆ°: ${YUNWU_API_BASE}/video/create`, 'info');
                addLog(`ğŸ“‹ è¯·æ±‚ä½“: ${JSON.stringify(requestBody, null, 2)}`, 'info');

                const response = await fetch(`${YUNWU_API_BASE}/video/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();
                addLog(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                addLog(`ğŸ“¥ å“åº”å†…å®¹: ${responseText.substring(0, 500)}`, response.ok ? 'success' : 'error');

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº” JSON: ${e.message}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'è¯·æ±‚å¤±è´¥');
                }

                resultDiv.innerHTML = `<div class="success">âœ… æäº¤æˆåŠŸ!</div>\n\n` +
                    `<div><span class="label">ä»»åŠ¡ ID:</span><span class="value">${data.id}</span></div>\n` +
                    `<div><span class="label">çŠ¶æ€:</span><span class="value">${data.status}</span></div>\n` +
                    `<div><span class="label">æ›´æ–°æ—¶é—´:</span><span class="value">${new Date(data.status_update_time).toLocaleString()}</span></div>\n\n` +
                    `å®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;

                // è‡ªåŠ¨å¡«å……ä»»åŠ¡ ID
                document.getElementById('taskId').value = data.id;
                addLog(`âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼ŒID: ${data.id}`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>\n\n` +
                    `è¯·æ£€æŸ¥:\n` +
                    `1. API Key æ˜¯å¦æ­£ç¡®\n` +
                    `2. API Key æ˜¯å¦æœ‰è®¿é—® sora-2 æ¨¡å‹çš„æƒé™\n` +
                    `3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n` +
                    `4. è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³`;
                addLog(`âŒ æäº¤å¤±è´¥: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æµ‹è¯•æäº¤ä»»åŠ¡';
            }
        }

        async function testQueryTask() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('è¯·å…ˆä¿å­˜ API Key');
                return;
            }

            const taskId = document.getElementById('taskId').value.trim();
            if (!taskId) {
                alert('è¯·è¾“å…¥ä»»åŠ¡ ID');
                return;
            }

            const queryBtn = document.getElementById('queryBtn');
            const resultDiv = document.getElementById('queryResult');

            queryBtn.disabled = true;
            queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
            resultDiv.innerHTML = '<div class="info">â³ æ­£åœ¨æŸ¥è¯¢ä»»åŠ¡...</div>';

            try {
                addLog(`ğŸ“¤ å‘é€æŸ¥è¯¢è¯·æ±‚: ${YUNWU_API_BASE}/video/query?id=${taskId}`, 'info');

                const response = await fetch(`${YUNWU_API_BASE}/video/query?id=${encodeURIComponent(taskId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    }
                });

                const responseText = await response.text();
                addLog(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                addLog(`ğŸ“¥ å“åº”å†…å®¹: ${responseText.substring(0, 500)}`, response.ok ? 'success' : 'error');

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº” JSON: ${e.message}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'æŸ¥è¯¢å¤±è´¥');
                }

                const detail = data.detail || {};
                const progress = detail.progress_pct || 0;
                const status = detail.status || 'unknown';

                let statusClass = 'pending';
                if (status === 'succeeded' || status === 'completed') statusClass = 'success';
                if (status === 'failed' || status === 'error') statusClass = 'error';

                resultDiv.innerHTML = `<div><span class="label">ä»»åŠ¡ ID:</span><span class="value">${data.id}</span></div>\n` +
                    `<div><span class="label">çŠ¶æ€:</span><span class="status-badge ${statusClass}">${status}</span></div>\n` +
                    `<div><span class="label">è¿›åº¦:</span><span class="value">${progress}%</span></div>\n` +
                    `<div><span class="label">ç”Ÿæˆæ•°é‡:</span><span class="value">${detail.generations?.length || 0}</span></div>\n\n` +
                    `å®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;

                addLog(`âœ… æŸ¥è¯¢æˆåŠŸ: ${status}, è¿›åº¦ ${progress}%`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
                addLog(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = 'æµ‹è¯•æŸ¥è¯¢ä»»åŠ¡';
            }
        }

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `<div class="${type}">[${timestamp}] ${message}</div>`;
            logsDiv.innerHTML = logLine + logsDiv.innerHTML;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
    </script>
</body>
</html>
